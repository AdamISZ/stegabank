<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Home</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
</head>

<body onload="homepageLoaded()">
<div class="container">
<div class="navbar">
    <div class="navbar-inner">
    <ul class="nav">
        <li class="active"><a href="home.html">Home</a></li>
        <li><a href="escrows.html">Escrows</a></li>
        <li><a href="advanced.html">Advanced</a></li>
    </ul>
    </div>
</div>

<div class="hero-unit">
<p  style="margin-left:0;margin-bottom:0;margin-top:0;">Welcome to Alpha testing of Paysty  ['peisti]. </p>
</div>
<button class="btn btn-primary btn-lg" style="margin-bottom:30px;" onclick="startPressed()">Start the fun</button>
<!-- <button class="btn btn-primary btn-lg" style="margin-bottom:30px;" onclick="terminatePressed()">Terminate</button>
 -->
<p>Below you'll see everything that is going on under the hood so that you could report to developers in case of a problem:</p>
<textarea id="textarea" cols="40" rows="5" type="text" name="message" style="width:100%;resize:none;" autocomplete="off" readonly>
</textarea>
<div class="row">
<p>Unique id: </p>
<textarea id="uniqueid" cols="35" rows="1" type="text" name="uid" autocomplete="off"></textarea>
<p>Ctrprty Unique id: </p>
<textarea id="ctrprtyuniqueid" cols="35" rows="1" type="text" name="cuid" autocomplete="off"></textarea>
</div>
<div class="row">
<div class="span6">
<p>Chat in this box:</p>
<textarea id="textareachat" cols="30" rows="10" type="text" name="messagechat" onkeyup="chatReceived(event)" style="width:90%;resize:none;" autocomplete="off"></textarea>
</div>
<div class="span6">
<p>Responses in this box:</p>
<textarea id="rtextareachat" cols="30" rows="10" type="text" name="messagechatback" style="width:90%;resize:none;" autocomplete="off" readonly="readonly"></textarea>
</div>
</div>

<div class="row">
<div class="span4">
<p>Create crypto keys for transaction and share with counterparty</p>
<button class="btn btn-primary btn-lg" style="margin-bottom:30px;" onclick="setupmultisig()">Setup escrow</button>
<textarea id="tempaddress" cols="35" rows="1" type="text" name="taddr" readonly="readonly"></textarea>
<p>Generated multisig bitcoin address for the escrow:</p>
<textarea id="msigaddr" cols="35" rows="1" type="text" name="maddr" readonly="readonly"></textarea>
<p>Multisig address current balance:</p>
<textarea id="msigbalance" cols="15" rows="1" type="text" name="mbal" readonly="readonly"></textarea>
</div>    
<div class="span4">
<p>Sign the spending transaction and send to counterparty</p>
<button class="btn btn-primary btn-lg" style="margin-bottom:30px;" onclick="signtx()">Sign and send</button>
<p>Address to receive the coins:</p>
<textarea id="receiveaddr" cols="35" rows="1" type="text" name="radd"></textarea>
</div>
<div class="span4">
<p>Transmit signed transaction to network (final transfer of BTC)</p>
<button class="btn btn-primary btn-lg" style="margin-bottom:30px;" onclick="startPressed()">Transmit</button>    
</div>
</div>

</div>


<script>
log("Paysty started")

var reqCheckEscrow
var reqStartTunnel
var reqsetup
var isCheckEscrowResponded = false
var isStartTunnelResponded = false
var crc=1

var port = Components.classes["@mozilla.org/process/environment;1"].getService(Components.interfaces.nsIEnvironment).get("FF_to_backend_port")
log("")
log_toolbar("")

function signtx(){
    var ra = document.getElementById("receiveaddr").value;
    var bal = document.getElementById("msigbalance").value;
    var u1 = document.getElementById("uniqueid").value;
    var u2 = document.getElementById("ctrprtyuniqueid").value;
    if (bal == null){
        alert("no balance, doing nothing");
        return;
    }
    reqsign = new XMLHttpRequest();
    reqsign.open("HEAD","http://127.0.0.1:"+port+"/sign_tx?"+ra+" "+mbal+" "+u1+" "+u2,true);
    reqsign.onload = function (e){
        var query = reqsign.getResponseHeader("response");
        var result = reqsign.getResponseHeader("result");
        if (query != "sign_tx"){
            log("Internal error. Wrong response header: "+query);
        }
        if (result != "success"){
            log("Sign transaction: "+result);
        }
        alert("Transaction signed successfully");
    }
    reqsign.send();
}

function setupmultisig(){
    
    reqsetup = new XMLHttpRequest();
    u1 = document.getElementById("uniqueid").value;
    u2 = document.getElementById("ctrprtyuniqueid").value;
    reqsetup.open("HEAD","http://127.0.0.1:"+port+"/setup_multisig?"+u1+" "+u2,true);
    reqsetup.onload = function (e){
        var query = reqsetup.getResponseHeader("response");
        var addr = reqsetup.getResponseHeader("addr");
        var pub = reqsetup.getResponseHeader("pub");
        var maddr = reqsetup.getResponseHeader("maddr");
        if (query != "setup_multisig"){
            log("Internal error. Wrong response header: "+query);
            return;
        }
        cta = document.getElementById("tempaddress");
        cta.value = addr ;
        //we also send out the public key to the counterparty via the chat server
        cp = document.getElementById("ctrprtyuniqueid").value;
        m = cp+' msig_share '+pub;
        if (maddr != null){
            document.getElementById("msigaddr").value = maddr;
        }
        sendChat(m);
    }
    reqsetup.send();
}

function homepageLoaded () {
    document.getElementById("textarea").value = "";
    document.getElementById("textareachat").value = "";
    document.getElementById("msigaddr").value = "";
    document.getElementById("uniqueid").value = "2eaadd3daf2ba02705b32b448f186e85796d54c3e577d176b68a692847bb25b1";
    document.getElementById("ctrprtyuniqueid").value = "74d59a321faeb23aaaba7ce105a4d0f57a4a2ee91dfa7fb80cb3b11d4875cef8";
}

//endless loop. Other pages use preferences to send info that needs to be logged.
getMsg()

function getMsg() {
    var branch = Components.classes["@mozilla.org/preferences-service;1"]
                    .getService(Components.interfaces.nsIPrefService).getBranch("extensions.lspnr.")
    crc++;
    if (crc == 250){
        getctrprtychat();
        getmsigbalance();
        crc=0;
    }
    var msg = branch.getCharPref("msg_ipc")
    var chatmsg = branch.getCharPref("msg_chat")
    if (msg == "" && chatmsg == ""){
        setTimeout(getMsg, 10);
        return
    }
    if (chatmsg != ""){
        sendChat(chatmsg);
        branch.setCharPref("msg_chat","");
    }
    textarea = document.getElementById("textarea")
    now = new Date()
    //pad with leading zeroes when needed
    textarea.value += ("0"+now.getHours()).slice(-2)+":"+("0"+now.getMinutes()).slice(-2)+":"+("0"+now.getSeconds()).slice(-2)+" " +msg+"\n"
    branch.setCharPref("msg_ipc", "")
    textarea.scrollTop = textarea.scrollHeight;
    setTimeout(getMsg, 10);
}

function getmsigbalance(){
    if (document.getElementById("msigaddr").value == ''){
        return;
    }
    reqGetBalance = new XMLHttpRequest();
    reqGetBalance.open("HEAD","http://127.0.0.1:"+port+"/get_balance?"+document.getElementById("msigaddr").value,true);
    reqGetBalance.onload = function (e){
        var query = reqGetBalance.getResponseHeader("response");
        var conf = reqGetBalance.getResponseHeader("confirmedbalance");
        var unconf = reqGetBalance.getResponseHeader("unconfirmedbalance");
        if (query != "get_balance"){
            log("Internal error. Wrong response header: "+query);
        }
        document.getElementById("msigbalance").value = unconf; //todo: both balances
    }
    reqGetBalance.send();
}
        
function getctrprtychat(){
    reqGetChat = new XMLHttpRequest();
    reqGetChat.open("HEAD","http://127.0.0.1:"+port+"/receive_chat?",true);
    reqGetChat.onload = function (e){
        var query = reqGetChat.getResponseHeader("response");
        var value = reqGetChat.getResponseHeader("value");
        var rtype = reqGetChat.getResponseHeader("type");
        var sender = reqGetChat.getResponseHeader("sender");
        if (query != "receive_chat"){
            log("Internal error. Wrong response header: "+query);
            return;
        }
        if (sender != document.getElementById("ctrprtyuniqueid").value){
            if (sender != "none"){
                log("Wrong counterparty, ignoring message.");
            }
            return;
        }
        if (rtype == 'chatmessage'){
            if (value != null){
                cta = document.getElementById("rtextareachat");
                cta.value += value + '\n';
            }
        }
        else if (rtype == 'msig_share'){
            //we've received a public key from the counterparty; if
            //we've also generated our key, we can build the multisig now
            recv_ctrprty_pk(value);
            //cta = document.getElementById("msigaddr");
            //cta.value = value;
        }
    }
    reqGetChat.send();
}

function recv_ctrprty_pk(value){
    reqcreate2of3 = new XMLHttpRequest();
    x = document.getElementById("uniqueid").value;
    y = document.getElementById("ctrprtyuniqueid").value;
    reqcreate2of3.open("HEAD","http://127.0.0.1:"+port+"/recv_ctrprty_pk?"+x+" "+y+" "+value,true);
    reqcreate2of3.onload = function (e){
        var query = reqcreate2of3.getResponseHeader("response");
        var maddr = reqcreate2of3.getResponseHeader("msigaddr");
        if (query != "recv_ctrprty_pk"){
            log("Internal error. Wrong response header: "+query);
            return;
        }
        //alert("Maddr is: "+maddr);
        if (maddr != null){
            document.getElementById("msigaddr").value = maddr;
        }
    }
    reqcreate2of3.send();
}
    
    
    
function chatReceived(e){
    if (e.keyCode != 13){
        return;
    }
    
    var x = document.getElementById("textareachat").value;
    //only use the last line
    var res = x.split("\n");
    x = res[res.length-2];
    var cp = document.getElementById("ctrprtyuniqueid").value;
    
    var branch = Components.classes["@mozilla.org/preferences-service;1"]
                    .getService(Components.interfaces.nsIPrefService).getBranch("extensions.lspnr.");
    branch.setCharPref("msg_chat",cp+" "+"chatmessage"+" "+x);
}

function sendChat(m){
    reqChatSend = new XMLHttpRequest();
    reqChatSend.open("HEAD","http://127.0.0.1:"+port+"/send_chat?"+m,true);
    reqChatSend.send();
    
}

function terminatePressed(){
    reqTerminate = new XMLHttpRequest();
    reqTerminate.open("HEAD", "http://127.0.0.1:"+port+"/terminate", true);
    reqTerminate.send();    
}

function startPressed(){
    log_toolbar("")
    var branch = Components.classes["@mozilla.org/preferences-service;1"].getService(Components.interfaces.nsIPrefService).getBranch("extensions.lspnr.")
    branch.setBoolPref("start_new_session",true)
    check_default_escrow()
    //when response is received startTunnel() will be called from within the response handler
}

function check_default_escrow(){
    log("Checking oracle")
    var branch = Components.classes["@mozilla.org/preferences-service;1"].getService(Components.interfaces.nsIPrefService).getBranch("extensions.lspnr.");

    var escrow_name = branch.getCharPref("default_escrow")
    var dnsname = branch.getCharPref("escrow_"+escrow_name+".dnsname")
    var getuserurl = branch.getCharPref("escrow_"+escrow_name+".getuserurl")
    var listmetricsurl = branch.getCharPref("escrow_"+escrow_name+".listmetricsurl")
    var describeinstancesurl = branch.getCharPref("escrow_"+escrow_name+".describeinstancesurl")
    var describevolumesurl = branch.getCharPref("escrow_"+escrow_name+".describevolumesurl")
    var getconsoleoutputurl = branch.getCharPref("escrow_"+escrow_name+".getconsoleoutputurl")
    base64string = btoa(getuserurl+" "+listmetricsurl+" "+describeinstancesurl+" "+describevolumesurl+" " + getconsoleoutputurl +" "+ dnsname)

    reqCheckEscrow = new XMLHttpRequest();
    reqCheckEscrow.onload = responseCheckEscrow;
    reqCheckEscrow.open("HEAD", "http://127.0.0.1:"+port+"/check_oracle?"+base64string, true);
    reqCheckEscrow.send();
    //give 20 secs for escrow to respond
    setTimeout(responseCheckEscrow, 1000, 0)

}

function responseCheckEscrow(iteration){
    if (typeof iteration == "number"){
        if (iteration > 20){
            log("Oracle is taking more than 20 seconds to respond. Please check your internet connection and try again")
            return
        }
        if (!isCheckEscrowResponded) setTimeout(responseCheckEscrow, 1000, ++iteration)
        return
    }
    //else: not a timeout but a response from the server
    isCheckEscrowResponded = true
    var query = reqCheckEscrow.getResponseHeader("response");
    var value = reqCheckEscrow.getResponseHeader("value");

    if (query != "check_oracle"){
        log("Internal error. Wrong response header: "+query)
        return
    }
    if (value != "success"){
        ("Error while checkng oracle: "+ value +". Please let the developers know.")
        return
    }
    log("SUCCESS. Oracle checked")
    setTimeout(startTunnel, 1000)
}

function startTunnel (){
    var branch = Components.classes["@mozilla.org/preferences-service;1"]
                    .getService(Components.interfaces.nsIPrefService).getBranch("extensions.lspnr.");
    log("Asking backend to start tunnel")
    var escrow_name = branch.getCharPref("default_escrow")
    var dnsname = branch.getCharPref("escrow_"+escrow_name+".dnsname")
    //user ID is actually the forwarding port on oracle
    var sshport = branch.getCharPref("uid")

    reqStartTunnel = new XMLHttpRequest();
    reqStartTunnel.onload = responseStartTunnel;
    reqStartTunnel.open("HEAD", "http://127.0.0.1:"+port+"/start_tunnel?"+dnsname+";"+sshport, true);
    reqStartTunnel.send();
    setTimeout(responseStartTunnel, 1000, 0)

}

function responseStartTunnel(iteration){
    if (typeof iteration == "number"){
        if (iteration > 20){
            log("Oracle is taking more than 20 seconds to respond. Please check your internet connection and try again")
            return
        }
        if (!isStartTunnelResponded) setTimeout(responseCheckEscrow, 1000, ++iteration)
        return
    }
    //else: not a timeout but a response from the server
    isStartTunnelResponded = true
    var query = reqStartTunnel.getResponseHeader("response");
    var value = reqStartTunnel.getResponseHeader("value");
    if (query != "start_tunnel"){
        log("Internal error. Wrong response header: "+query)
        return
    }
    if (value.length > 9 ){
        if (value.slice(0,9) == 'reconnect'){
            var newport = value.split(';')[1]
            var branch = Components.classes["@mozilla.org/preferences-service;1"].getService(Components.interfaces.nsIPrefService).getBranch("extensions.lspnr.");
            branch.setCharPref("uid", newport)
            startTunnel()
            return
        }
    }
    if (value != "success"){
        log("FAILURE starting tunnel: "+ value +". Please let the developers know.")
        return
    }
    log("SUCCESS. Tunnel started")
    setTimeout(after_tunnel_started, 1000)
}

function after_tunnel_started(){
    log_toolbar("Navigate to your statement page, fill in the fields and press the blue button -->")
    alert("You can now open a new tab and login into your bank. Follow the instruction on the bottom toolbar")
}

function log(string){
    var branch = Components.classes["@mozilla.org/preferences-service;1"].getService(Components.interfaces.nsIPrefService).getBranch("extensions.lspnr.")
    branch.setCharPref("msg_ipc", string)
}

function log_toolbar(string){
    var branch = Components.classes["@mozilla.org/preferences-service;1"].getService(Components.interfaces.nsIPrefService).getBranch("extensions.lspnr.")
    branch.setCharPref("msg_toolbar", string)
}

function log_chat(string){
    var branch = Components.classes["@mozilla.org/preferences-service;1"].getService(Components.interfaces.nsIPrefService).getBranch("extensions.lspnr.")
    branch.setCharPref("msg_chat",string)
}

</script>


<script src="jquery-2.0.3.min.js"></script>
<script src="bootstrap-modal.js"></script>
<script src="bootstrap-transition.js"></script>
</body>
</html>